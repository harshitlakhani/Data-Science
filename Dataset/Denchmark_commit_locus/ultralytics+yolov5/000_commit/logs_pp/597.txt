create sotabench
import argparse import glob import json import import shutil pathlib import path import numpy import torch import yaml tqdm import tqdm models experimental import attempt load attemptload utils datasets import create dataloader createdataloader utils general import coco coco class cocotocococlass check dataset checkdataset check file checkfile check img size checkimgsize compute loss computeloss non max suppression nonmaxsuppression scale coords scalecoords xyxyxywh clip coords clipcoords plot images plotimages xywhxyxy box iou boxiou output target outputtotarget per class apperclass set logging setlogging utils torch utils torchutils import select device selectdevice time synchronized timesynchronized sotabencheval object detection objectdetection import coco evaluator cocoevaluator sotabencheval utils import server isserver dataroot data vision coco server isserver else coco sotabench data dir def test data weights none batch size batchsize imgsz conf thres confthres iou thres iouthres nms save json savejson false single cls singlecls false augment false verbose false model none dataloader none save dir savedir merge false save txt savetxt false initialize load model set device training model none training called train device next model parameters device get model device else called directly set logging setlogging device select device selectdevice opt device batch size batchsize batch size batchsize merge save txt savetxt opt merge opt save txt savetxt use merge nms save txt labels save txt savetxt path inference output path exists shutil rmtree delete output folder makedirs make new output folder remove previous glob glob str path save dir savedir test batch testbatch jpg remove load model model attempt load attemptload weights map location maplocation device load model imgsz check img size checkimgsize imgsz model stride max check img size imgsize multi gpu multigpu disabled incompatible half https github com ultralytics yolov issues device type cpu torch cuda device count devicecount model data parallel dataparallel model half half device type cpu half precision supported cuda half model half configure model eval open data data yaml load loader yaml full loader fullloader model dict check dataset checkdataset data check single cls singlecls else int data number classes iouv torch linspace device iou vector map niou iouv numel dataloader training img torch zeros imgsz imgsz device device init img model img half half else img device type cpu else none run path data test opt task test else data val path val test images dataloader create dataloader createdataloader path imgsz batch size batchsize model stride max opt hyp none augment false cache true pad rect true seen names model names hasattr model names else model module names cococlass coco coco class cocotocococlass class images targets map map map map loss torch zeros device device jdict stats class apclass evaluator coco evaluator cocoevaluator root dataroot model name modelname opt weights replace batch batchi img targets paths shapes enumerate tqdm dataloader desc img img device non blocking nonblocking true img img half half else img float uint img targets targets device height width img shape batch size channels height width whwh torch tensor width height width height device disable gradients torch grad nograd run model time synchronized timesynchronized inf infout train trainout model img augment augment inference training outputs time synchronized timesynchronized compute loss training model loss hyperparameters loss compute loss computeloss float train trainout targets model giou obj cls run nms time synchronized timesynchronized output non max suppression nonmaxsuppression inf infout conf thres confthres conf thres confthres iou thres iouthres iou thres iouthres merge merge time synchronized timesynchronized statistics per image pred enumerate output labels targetstargets len labels tcls labels tolist else target class seen pred none stats append torch zeros niou dtype torch bool torch tensor torch tensor tcls continue append text file save txt savetxt torch tensor shapessi normalization gain whwh pred clone scale coords scalecoords imgsi shape shapessi shapessi original xyxy conf cls xywh xyxyxywh torch tensor xyxy view view tolist normalized xywh open str path pathssi stem txt write cls xywh label format clip boxes image bounds clip coords clipcoords pred height width append pycocotools json dictionary save json savejson image imageid category categoryid bbox score image imageid path pathssi stem box pred clone xyxy scale coords scalecoords imgsi shape box shapessi shapessi original shape box xyxyxywh box xywh box box center top left topleft corner zip pred tolist box tolist result image imageid int image imageid image imageid isnumeric else image imageid category categoryid cococlassint bbox round score round jdict append result evaluator add result evaluator cache exists cacheexists break assign predictions incorrect correct torch zeros pred shape niou dtype torch bool device device detected target indices tcls tensor tclstensor labels target boxes tbox xywhxyxy labels whwh per target class cls torch unique tcls tensor tclstensor cls tcls tensor tclstensor nonzero tuple astuple false view prediction indices cls pred nonzero tuple astuple false view target indices search detections shape prediction target ious ious box iou boxiou predpi tboxti max best ious indices append detections detected set detectedset set ious iouv nonzero tuple astuple false tiij detected target item detected set detectedset detected set detectedset add item detected append correctpij iousj iouv iou thres iouthres len detected targets already located image break append statistics correct conf pcls tcls stats append correct cpu pred cpu pred cpu tcls plot images batch batchi len stats enumerate class apclass print namesc seen ntc api api print speeds tuple seen imgsz imgsz batch size batchsize tuple training print speed inference nms total per gxg image batch size batchsize save json save json savejson len jdict detections vals results detectionsvalsresults json weights split sep replace isinstance weights str else filename print coco ncoco map pycocotools saving open file json dump jdict file try https github com cocodataset cocoapi blob master python api pythonapi pycoco eval demo pycocoevaldemo ipynb pycocotools coco import coco pycocotools cocoeval import coc oeval cocoeval img ids imgids int path stem dataloader dataset img files imgfiles coco cocogt coco glob glob coco annotations instances val instancesval json initialize coco ground truth api coco cocodt coco cocogt load res loadres initialize coco pred api coco eval cocoeval coc oeval cocoeval coco cocogt coco cocodt bbox coco eval cocoeval params img ids imgids img ids imgids image ids evaluate coco eval cocoeval evaluate coco eval cocoeval accumulate coco eval cocoeval summarize map map coco eval cocoeval stats update results map map except exception print error pycocotools unable run return results model float training maps zeros map enumerate class apclass mapsc api return map map loss cpu len dataloader tolist maps name main parser argparse argument parser argumentparser prog test parser add argument addargument weights nargs type str default yolovs help model path parser add argument addargument data type str default data coco yaml help data path parser add argument addargument batch size batchsize type int default help size image batch parser add argument addargument img size imgsize type int default help inference size pixels parser add argument addargument conf thres confthres type float default help object confidence threshold parser add argument addargument iou thres iouthres type float default help iou threshold nms parser add argument addargument save json savejson action store true storetrue help save cocoapi compatible cocoapicompatible json results file parser add argument addargument task default val help val test study parser add argument addargument device default help cuda device cpu parser add argument addargument single cls singlecls action store true storetrue help treat single class singleclass dataset parser add argument addargument augment action store true storetrue help augmented inference parser add argument addargument merge action store true storetrue help use merge nms parser add argument addargument verbose action store true storetrue help report map class parser add argument addargument save txt savetxt action store true storetrue help save results txt opt parser parse args parseargs opt save json savejson opt data endswith coco yaml opt data check file checkfile opt data check file print opt opt task val test run normally test opt data opt weights opt batch size batchsize opt img size imgsize opt conf thres confthres opt iou thres iouthres opt save json savejson opt single cls singlecls opt augment opt verbose elif opt task study run range settings save plot weights yolovs yolovm yolovl yolovx studyss txt path opt data stem path weights stem filename save list range axis axis img size imgsize print running nrunning point test opt data weights opt batch size batchsize opt conf thres confthres opt iou thres iouthres opt save json savejson append results times savetxt fmt save system zip study zip study txt utils general plot study txt plotstudytxt plot newline end file
