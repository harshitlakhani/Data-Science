initial commit
import glob import math import import random import shutil import subprocess import time copy import copy pathlib import path sys import platform import import matplotlib import matplotlib pyplot plt import numpy import torch import torch import torchvision scipy signal import butter filtfilt tqdm import tqdm import torch utils torchutils google utils googleutils 혻torch utils 혻torchutils google utils googleutils set printoptions torch set printoptions setprintoptions linewidth precision profile long set printoptions setprintoptions linewidth formatter float kind floatkind format format short precision matplotlib font size prevent open opencv multithreading use torch pytorch data loader dataloader set num threads setnumthreads def init seeds initseeds seed random seed seed random seed seed torch utils torchutils init seeds initseeds seed seed def check git status checkgitstatus platform linux darwin suggest git pull repo date subprocess check output checkoutput git git fetch git status uno shell true decode utf branch behind print find branch behind find def make divisible makedivisible divisor returns evenly divisble divisor return math ceil divisor divisor def labels class weights labelstoclassweights labels get class weights inverse frequency training labels labels none labels loaded return torch tensor labels concatenate labels labels shape coco classes labels astype int labels class xywh weights bincount classes minlength occurences per class prepend gridpoint count uce trianing gpi array sum gridpoints per image weights hstack gpi len labels weights sum weights prepend gridpoints start weightsweights replace empty bins weights weights number targets per class weights weights sum normalize return torch numpy fromnumpy weights def labels image weights labelstoimageweights labels class weights classweights ones produces image weights based class maps len labels class counts classcounts array bincount labelsi astype int minlength range image weights imageweights class weights classweights reshape class counts classcounts sum index random choices range weights image weights imageweights weight image sample return image weights imageweights def coco coco class cocotocococlass converts index val index paper https tech amikelive com node object categories labels coco dataset whatobjectcategorieslabelsareincocodataset loadtxt data coco names dtype str delimiter loadtxt data coco paper cocopaper names dtype str delimiter list index true range darknet coco list index true else none range coco darknet return def xyxyxywh convert boxes top left topleft bottom right bottomright torch zeros like zeroslike isinstance torch tensor else zeros like zeroslike center center width height return def xywhxyxy convert boxes top left topleft bottom right bottomright torch zeros like zeroslike isinstance torch tensor else zeros like zeroslike top left top left bottom right bottom right return def scale coords scalecoords img shape imgshape coords img shape imgshape ratio pad ratiopad none rescale coords xyxy img shape imgshape img shape imgshape ratio pad ratiopad none calculate img shape imgshape gain max img shape imgshape max img shape imgshape gain old new pad img shape imgshape img shape imgshape gain img shape imgshape img shape imgshape gain padding else gain ratio pad ratiopad pad ratio pad ratiopad coords pad padding coords pad padding coords gain clip coords clipcoords coords img shape imgshape return coords def clip coords clipcoords boxes img shape imgshape clip bounding xyxy bounding boxes image shape height width boxes clamp img shape imgshape boxes clamp img shape imgshape boxes clamp img shape imgshape boxes clamp img shape imgshape def per class apperclass conf pred cls predcls target cls targetcls compute average precision given recall precision curves source https github com rafaelpadilla object detection metrics objectdetectionmetrics arguments true positives nparray conf objectness value nparray pred cls predcls predicted object classes nparray target cls targetcls true object classes nparray returns average precision computed faster rcnn pyfasterrcnn sort objectness argsort conf conf pred cls predcls tpi confi pred clsi predclsi find unique classes unique classes uniqueclasses unique target cls targetcls create precision recall precisionrecall curve compute class score prscore score evaluate https github com ultralytics yolov issues unique classes uniqueclasses shape shape number class number iou thresholds map zeros zeros zeros enumerate unique classes uniqueclasses pred cls predcls ngt target cls targetcls sum number ground truth objects sum number predicted objects ngt continue else accumulate fps tps fpc tpi cumsum tpc tpi cumsum recall recall tpc ngt recall curve rci interp score prscore confi recall score prscore negative decreases precision precision tpc tpc fpc precision curve pci interp score prscore confi precision score prscore recall precision recallprecision curve range shape apci compute computeap recall precision plot fig plt subplots figsize plot recall precision set xlabel setxlabel recall set ylabel setylabel precision set xlim setxlim set ylim setylim fig tight layout tightlayout fig savefig curve prcurve png dpi compute score harmonic mean precision recall return unique classes uniqueclasses astype int def compute computeap recall precision compute average precision given recall precision curves source https github com rbgirshick faster rcnn pyfasterrcnn arguments recall recall curve list precision precision curve list returns average precision computed faster rcnn pyfasterrcnn append sentinel values beginning end mrec concatenate recall min recall mpre concatenate precision compute precision envelope mpre flip maximum accumulate flip mpre integrate area curve method interp methods continuous interp method interp linspace point interp coco trapz interp mrec mpre integrate else continuous mrec mrec points axis recall changes sum mreci mreci mprei area curve return def bbox iou bboxiou box box xyxy true giou false diou false ciou false returns iou box box box box box box get coordinates bounding boxes xyxy box box box box box box box box box else transform xywh xyxy box box box box box box box box box box box box box box box box intersection area inter torch min torch max clamp torch min torch max clamp union area union inter iou inter union iou giou diou ciou torch max torch min convex smallest enclosing box width torch max torch min convex height giou generalized iou https arxiv org pdf pdf area carea convex area return iou area carea union area carea giou diou ciou distance complete iou https arxiv org abs convex diagonal squared centerpoint distance squared rho diou return iou rho diou elif ciou https github com zzh tju zzhtju ussd pytorch dioussdpytorch blob master utils box box utils boxutils pyl math torch pow torch atan torch atan torch grad nograd alpha iou return iou rho alpha ciou return iou def box iou boxiou box box https github com pytorch vision blob master torchvision ops boxes return intersection union intersectionoverunion jaccard index boxes sets boxes expected format arguments box tensor tensorn box tensor tensorm returns iou tensor tensorn nxm matrix containing pairwise iou values every element boxes boxes def box area boxarea box box return box box box box area box area boxarea box area box area boxarea box inter clamp prod inter torch min box none box torch max box none box clamp prod return inter area none area inter iou inter area area inter def iou whiou returns nxm iou matrix none none whnone inter torch min prod return inter prod prod inter iou inter area area inter class focal loss focalloss module wraps focal loss around existing loss fcn lossfcn criteria focal loss focalloss bce logits loss bcewithlogitsloss gamma def init self loss fcn lossfcn gamma alpha super focal loss focalloss self init self loss fcn lossfcn loss fcn lossfcn must bce logits loss bcewithlogitsloss self gamma gamma self alpha alpha self reduction loss fcn lossfcn reduction self loss fcn lossfcn reduction none required apply element def forward self pred true loss self loss fcn lossfcn pred true torch exp loss loss self alpha self gamma non zero nonzero power gradient stability implementation https github com tensorflow addons blob tensorflow addons tensorflowaddons losses focal loss focalloss pred prob predprob torch sigmoid pred prob logits true pred prob predprob true pred prob predprob alpha factor alphafactor true self alpha true self alpha modulating factor modulatingfactor self gamma loss alpha factor alphafactor modulating factor modulatingfactor self reduction mean return loss mean elif self reduction sum return loss sum else none return loss def smooth bce smoothbce eps https github com ultralytics yolov issues issuecomment return positive negative label smoothing bce targets return eps eps def compute loss computeloss targets model predictions targets model torch cuda float tensor floattensor cuda iscuda else torch tensor lcls lbox lobj tcls tbox indices anchors build targets buildtargets targets model targets model hyp hyperparameters red mean loss reduction sum mean define criteria ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight cls clspw reduction red eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight obj objpw reduction red class label smoothing https arxiv org pdf pdf eqn smooth bce smoothbce eps focal loss gamma flgamma focal loss gamma ecls bcecls eobj bceobj focal loss focalloss ecls bcecls focal loss focalloss eobj bceobj per output targets enumerate layer index layer predictions indicesi image anchor gridy gridx tobj torch zeros like zeroslike target obj shape number targets cumulative targets pib prediction subset corresponding targets giou pxy sigmoid pwh sigmoid anchorsi pbox torch cat pxy pwh predicted box giou bbox iou bboxiou pbox tboxi xyxy false giou true giou prediction target lbox giou sum red sum else giou mean giou loss obj tobjb model model giou detach clamp type tobj dtype giou ratio class model cls loss multiple classes torch full like fulllike targets trange tclsi lcls ecls bcecls bce append targets text file open targets txt file file write tuple torch cat txyi twhi lobj eobj bceobj tobj obj loss lbox giou lobj obj lcls cls tobj shape batch size red sum loss gain lobj lcls model lbox loss lbox lobj lcls return loss torch cat lbox lobj lcls loss detach def build targets buildtargets targets model build targets compute loss computeloss input targets image class det model module model type model parallel data parallel dataparallel parallel distributed data parallel distributeddataparallel else model model detect module det targets shape number anchors targets tcls tbox indices anch gain torch ones device targets device normalized gridspace gain torch tensor device targets device float overlap offsets torch arange view repeat anchor tensor repeat interleave repeatinterleave style rect range det anchors det anchorsi gain torch tensor shape xyxy gain match targets anchors offsets targets gain none tnone anchors none ratio torch max max model hyp iou iout iou iou whiou anchors gwh atj repeat filter overlaps gxy grid torch zeros like zeroslike gxy style rect offset gxy torch cat torch cat offsets torch cat elif style rect offset gxy gxy gxy multiple labels per box output none prediction shape enumerate prediction image index image inference apply constraints conf thres confthres confidence min minwh conf thres confthres nonzero torch cat boxi unsqueeze float unsqueeze else best class conf max torch cat box conf unsqueeze float unsqueeze conf conf thres confthres filter class classes view torch tensor classes device device apply finite constraint torch isfinite xtorch isfinite none remain process next image shape number boxes continue sort confidence argsort descending true batched nms agnostic else classes boxes scores clone view max maxwh boxes offset class scores torchvision ops boxes nms boxes scores iou thres iouthres merge iou thres iouthres iou matrix weights iou scores none scoresnone box weights torch weights float weights sum keepdim true merged boxes iiou sum require redundancy except possible cuda error https github com ultralytics yolov issues print shape shape pass outputxi time time time limit timelimit break time limit exceeded return output def strip optimizer stripoptimizer weights best utils utils import strip optimizer stripoptimizer strip optimizer files lighter files reduced size torch load map location maplocation torch device cpu optimizer none torch save print optimizer stripped def create backbone createbackbone weights best weights backbone utils utils import create backbone createbackbone create backbone torch load map location maplocation torch device cpu optimizer none training results trainingresults none epoch model parameters requires grad requiresgrad true torch save print modified backbone use saved def coco class count cococlasscount path coco labels train histogram occurrences per class number classes zeros dtype int files sorted glob glob path file enumerate files labels loadtxt file dtype float reshape bincount labels astype int minlength print len files def coco people cocoonlypeople path coco labels train utils utils import coco people cocoonlypeople find images people files sorted glob glob path file enumerate files labels loadtxt file dtype float reshape labels print labels shape file def crop images random cropimagesrandom path images scale utils utils import crop images random cropimagesrandom crops images random squares scale fraction warning overwrites images file tqdm sorted glob glob path img imread file bgr img none img shape create random mask minimum size pixels mask maskh random randint int max scale mask height mask maskw mask maskh mask width box xmin max random randint mask maskw ymin max random randint mask maskh xmax min xmin mask maskw ymax min ymin mask maskh apply random color mask imwrite file imgymin ymax xmin xmax def coco single class labels cocosingleclasslabels path coco labels train label class labelclass makes single class singleclass coco datasets utils utils import coco single class labels cocosingleclasslabels path exists new shutil rmtree new delete output folder makedirs new make new output folder makedirs new labels makedirs new images file tqdm sorted glob glob path open file labels array split read splitlines dtype float labels label class labelclass img file imgfile file replace labels images replace txt jpg labels reset class open new images txt add image dataset list write img file imgfile open new labels path file name write label labelsi write tuple shutil copyfile src img file imgfile dst new images path file name replace txt jpg copy images def kmean anchors kmeananchors path data coco txt img size imgsize thr gen creates kmeans anchors use cfg files utils utils import kmean anchors kmeananchors number anchors img size imgsize min max image size used multi scale multiscale training values thr iou threshold hyperparameter used training gen generations evolve anchors using genetic algorithm utils datasets import load images labels loadimagesandlabels def print results printresults knp argsort prod sort small large iou iou whiou torch tensor max iou maxiou iou max bpr aat max iou maxiou thr float mean iou thr float mean best possible recall anch thr thr none none knone torch max max max maxar min bpr aat max maxar thr print iou thr iouthr best possible recall anchors thr thr bpr aat print img size imgsize iouall mean fmean best iou thr mean fmean img size imgsize iou mean max iou maxiou mean iouiou thr mean end enumerate print round round end thr float mean product def fitness ratio fitnessratio mutation fitness none none knone torch max max min return remove threshold boxes copy print results printresults print results printresults return def print mutation printmutation hyp results bucket print mutation results evolve txt use train evolve len hyp tuple hyp keys hyperparam keys len hyp tuple hyp values hyperparam values len results results results map test loss testloss print nsnsn evolved nsnsnevolved fitness bucket system gsutil evolve txt bucket download evolve txt open evolve txt append result write unique loadtxt evolve txt ndmin axis load unique rows savetxt evolve txt xnp argsort fitness save sort fitness bucket system gsutil evolve txt bucket upload evolve txt def apply classifier applyclassifier model img applies second stage classifier yolo outputs isinstance ndarray else enumerate per image none len clone reshape pad cutouts xyxyxywh boxes max unsqueeze rectangle square pad xywhxyxy long rescale boxes img size imgsize size scale coords scalecoords img shape imi shape classes pred cls predcls long ims enumerate per item cutout imiint int int int resize cutout bgr imwrite testi jpg cutout transpose bgr rgb ascontiguousarray dtype float uint float ims append pred cls predcls model torch tensor ims device argmax classifier prediction xipred cls xipredcls pred cls predcls retain matching class detections return def fitness returns fitness use results txt evolve txt weights map map return sum def output target outputtotarget output width height convert yolo model output target format batch batchid class classid conf isinstance output torch tensor output output cpu numpy targets enumerate output none pred box pred box box width box box height box width box height conf pred cls int pred targets append cls conf return array targets plotting functions def butter lowpass filtfilt butterlowpassfiltfilt data cutoff order https stackoverflow com questions filter smooth scipy numpy howtofiltersmoothwithscipynumpy def butter lowpass butterlowpass cutoff order nyq normal cutoff normalcutoff cutoff nyq butter order normal cutoff normalcutoff btype low analog false return butter lowpass butterlowpass cutoff order order return filtfilt data forward backward forwardbackward filter def plot one box plotonebox img color none label none line thickness linethickness none plots one bounding box image img line thickness linethickness round img shape img shape line font thickness color color random randint range int int int int rectangle img color thickness line type linetype lineaa label max font thickness size tsize get text size gettextsize label font scale fontscale thickness size tsize size tsize rectangle img color lineaa filled put text puttext img label thickness line type linetype lineaa def plot methods plotwhmethods utils utils import plot methods plotwhmethods compares two methods width height widthheight anchor multiplication https github com ultralytics yolov issues arange exp torch sigmoid torch numpy fromnumpy numpy fig plt figure figsize dpi plt plot label yolo method plt plot label power method plt plot label power method plt xlim left right plt ylim bottom top plt xlabel input plt ylabel output plt legend fig tight layout tightlayout fig savefig comparison png dpi def plot images plotimages images targets paths none fname images jpg names none max size maxsize max subplots maxsubplots line thickness max font thickness path isfile fname overwrite return none isinstance images torch tensor images images cpu numpy isinstance targets torch tensor targets targets cpu numpy normalise unnormalise max images image targets imagetargets targetstargets boxes xywhxyxy image targets imagetargets classes image targets imagetargets astype int image targets imagetargets shape ground truth conf column conf none else image targets imagetargets check confidence presence pred boxes boxes block blockx boxes boxes block blocky box enumerate boxes cls int classesj color color lutcls colorlutcls len color lut colorlut cls namescls names else cls confj conf thresh label cls else cls confj plot one box plotonebox box mosaic label label color color line thickness linethickness draw image filename labels paths none label path basename pathsi trim char size tsize get text size gettextsize label font scale fontscale thickness put text puttext mosaic label block blockx block blocky size tsize thickness line type linetype lineaa image border rectangle mosaic block blockx block blocky block blockx block blocky thickness fname none mosaic resize mosaic int int interpolation interarea imwrite fname cvt color cvtcolor mosaic colorbgrrgb return mosaic def plot scheduler plotlrscheduler optimizer scheduler epochs plot simulating training full epochs optimizer scheduler copy optimizer copy scheduler modify originals range epochs scheduler step append optimizer param groups paramgroups plt plot label plt xlabel epoch plt ylabel plt grid plt xlim epochs plt ylim plt tight layout tightlayout plt savefig png dpi def plot test txt plottesttxt utils utils import plot test plottest plot test txt histograms loadtxt test txt dtype float box xyxyxywh box box fig plt subplots figsize tight layout tightlayout true histd bins cmax cmin set aspect setaspect equal plt savefig histd png dpi fig plt subplots figsize tight layout tightlayout true hist bins hist bins plt savefig histd png dpi def plot targets txt plottargetstxt utils utils import plot targets txt plottargetstxt plot targets txt histograms loadtxt targets txt dtype float targets targets width targets height targets fig plt subplots figsize tight layout tightlayout true ravel range axi hist bins label mean std axi legend axi set title settitle plt savefig targets jpg dpi def plot study txt plotstudytxt study txt none utils utils import plot study txt plotstudytxt plot study txt generated test loadtxt dtype float usecols ndmin arange shape none else array map map inference tinference img nms tnms img total ttotal img fig plt subplots figsize tight layout tightlayout true ravel range axi plot linewidth markersize axi set title settitle plt savefig replace txt png dpi def plot labels plotlabels labels plot dataset labels labels labels transpose classees boxes def histd xedges yedges linspace min max linspace min max hist xedges yedges histogramd xedges yedges xidx clip digitize xedges hist shape yidx clip digitize yedges hist shape return log histxidx yidx fig plt subplots figsize tight layout tightlayout true ravel hist bins int max set xlabel setxlabel classes scatter histd cmap jet set xlabel setxlabel set ylabel setylabel scatter histd cmap jet set xlabel setxlabel width set ylabel setylabel height plt savefig labels png dpi def plot evolution results plotevolutionresults hyp utils utils import plot evolution results plotevolutionresults hyp plot hyperparameter evolution results evolve txt loadtxt evolve txt ndmin fitness weights min weighted results plt figure figsize tight layout tightlayout true matplotlib font size enumerate hyp items weights sum weights sum best weighted result argmax best single result plt subplot plt plot max markersize plt plot plt title fontdict size limit characters print plt savefig evolve png dpi def plot results overlay plotresultsoverlay start stop utils utils import plot results overlay plotresultsoverlay plot training results txt overlaying train val losses train train train precision map val val val recall map legends giou objectness classification apf mapf titles sorted glob glob results txt glob glob downloads results txt results loadtxt usecols ndmin results shape number rows range start min stop stop else fig plt subplots figsize tight layout tightlayout true ravel range resultsj axi plot marker label smooth ysmooth butter lowpass filtfilt butterlowpassfiltfilt axi plot gradient smooth ysmooth marker label axi set title settitle axi legend axi set ylabel setylabel else none add filename fig savefig replace txt png dpi def plot results plotresults start stop bucket utils utils import plot results plotresults plot training results txt seen https github com ultralytics yolovtraining fig plt subplots figsize ravel giou objectness classification precision recall val giou val objectness val classification map map bucket system storage googleapis com files https storage googleapis com resultsg txt bucket else files glob glob results txt glob glob downloads results txt sorted files try results loadtxt usecols ndmin results shape number rows range start min stop stop else range resultsi nan dont show zero loss values normalize axi plot marker label path stem linewidth markersize axi set title settitle share train val loss axes axi get shared yaxes getsharedyaxes join axi axi except print warning plotting error skipping file fig tight layout tightlayout legend fig savefig results png dpi
