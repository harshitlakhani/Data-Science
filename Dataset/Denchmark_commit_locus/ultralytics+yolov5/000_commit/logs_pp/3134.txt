utils reorganization utils reorganization add new utils files cleanup simplify reduce datasets remove evolve load webcam loadwebcam cleanup
auto anchor autoanchor utils import numpy import torch import yaml scipy cluster import kmeans tqdm import tqdm def check anchor order checkanchororder check anchor order stride order yol yolov detect module correct necessary anchor grid anchorgrid prod view anchor area delta stride stride delta sign sign order print reversing anchor order anchors anchors flip anchor grid anchorgrid anchor grid anchorgrid flip def check anchors checkanchors dataset model thr imgsz check anchor fit data recompute necessary print analyzing nanalyzing anchors end model module model hasattr model module else model model detect shapes imgsz dataset shapes dataset shapes max keepdims true scale random uniform size shapes shape augment scale torch tensor concatenate zip shapes scale dataset labels float def metric compute metric none none knone torch min min ratio metric best max best bestx aat thr float sum mean anchors threshold bpr best thr float mean best possible recall return bpr aat bpr aat metric anchor grid anchorgrid clone cpu view print anchors target best possible recall bpr aat bpr end bpr bpr replace anchors new anchors newanchors torch tensor new anchors newanchors device anchors device type typeas anchors anchor grid anchorgrid new anchors newanchors clone view viewas anchor grid anchorgrid inference anchors new anchors newanchors clone view viewas anchors stride anchors device view loss check anchor order checkanchororder print new anchors saved model update model yaml use anchors future else print original anchors better new anchors proceeding original anchors print newline def kmean anchors kmeananchors path data coco yaml img size imgsize thr gen verbose true creates kmeans evolved kmeansevolved anchors training dataset arguments path path dataset yaml loaded dataset number anchors img size imgsize image size used training thr anchor label anchorlabel ratio threshold hyperparameter hyp anchor anchort used training default gen generations evolve anchors using genetic algorithm verbose print results return kmeans evolved anchors usage utils general import kmean anchors kmeananchors thr thr def metric compute metrics none none knone torch min min ratio metric iou whiou torch tensor iou metric return max best bestx def anchor fitness anchorfitness mutation fitness best metric torch tensor dtype torch float return best best thr float mean fitness def print results printresults knp argsort prod sort small large best metric bpr aat best thr float mean thr float mean best possible recall anch thr print thr best possible recall anchors past thr thr bpr aat print img size imgsize metric metricall mean fmean best past thr pastthr mean fmean img size imgsize mean best mean thr mean end enumerate print round round end filter pixels kmeans calculation print running kmeans anchors points len std sigmas whitening dist kmeans iter points mean distance torch tensor dtype torch float filtered torch tensor dtype torch float unfiltered print results printresults plot none none tqdm range kmeans points mean distance fig plt subplots figsize ravel plot arange array marker fig plt subplots figsize plot hist whwh copy pbar desc evolving anchors genetic algorithm fitness verbose print results printresults return print results printresults
