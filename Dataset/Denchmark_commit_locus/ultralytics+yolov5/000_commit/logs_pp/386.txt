initial commit
import argparse utils datasets import utils utils import onnxexport false def detect save img saveimg false imgsz onnxexport else opt img size imgsize height width source weights half view img viewimg save txt savetxt opt output opt source opt weights opt half opt view img viewimg opt save txt savetxt webcam source source startswith rtsp source startswith http source endswith txt initialize device torch utils torchutils select device selectdevice device cpu onnxexport else opt device path exists shutil rmtree delete output folder makedirs make new output folder load model google utils googleutils attempt download attemptdownload weights model torch load weights map location maplocation device model torch save torch load weights map location maplocation device weights update model source change warning sourcechangewarning second stage secondstage classifier classify false classify modelc torch utils torchutils load classifier loadclassifier name resnet initialize modelc load state dict loadstatedict torch load weights resnet map location maplocation device model load weights modelc device eval eval mode model device eval fuse convd batch normd batchnormd layers model fuse export mode onnxexport model fuse img torch zeros imgsz opt weights replace opt weights split onnx onnx filename torch onnx export model img verbose false opset version opsetversion validate exported model import onnx model onnx load load onnx model onnx checker check model checkmodel model check well formed print onnx helper printable graph printablegraph model graph print human readable representation graph return half precision half half device type cpu half precision supported cuda half model half set dataloader vid path vidpath vid writer vidwriter none none webcam view img viewimg true torch backends cudnn benchmark true set true speed constant image size inference dataset load streams loadstreams source img size imgsize imgsz else save img saveimg true dataset load images loadimages source img size imgsize imgsz get names colors names model names colors random randint range range len names run inference time time img torch zeros imgsz imgsz device device init img model img half half else img float device type cpu else none run path img ims vid cap vidcap dataset img torch numpy fromnumpy img device img img half half else img float uint img img ndimension img img unsqueeze inference torch utils torchutils time synchronized timesynchronized pred model img augment opt augment torch utils torchutils time synchronized timesynchronized float half pred pred float apply nms pred non max suppression nonmaxsuppression pred opt conf thres confthres opt iou thres iouthres multi label multilabel false classes opt classes agnostic opt agnostic nms agnosticnms apply classifier classify pred apply classifier applyclassifier pred modelc img ims process detections det enumerate pred detections per image webcam batch size batchsize pathi imsi else path ims save path savepath str path path name gxg img shape print string torch tensor shape í˜»normalization gain whwh det none len det rescale boxes img size imgsize size det scale coords scalecoords img shape det shape round print results det unique det sum detections per class namesint add string write results xyxy conf cls det save txt savetxt write file xywh xyxyxywh torch tensor xyxy view view tolist normalized xywh open save path savepath save path savepath rfind txt file file write cls xywh label format save img saveimg view img viewimg add bbox image label namesint cls conf plot one box plotonebox xyxy label label color colorsint cls line thickness linethickness print time inference nms print done sdone stream results view img viewimg imshow wait key waitkey ord quit raise stop iteration stopiteration save results image detections save img saveimg dataset mode images imwrite save path savepath else vid path vidpath save path savepath new video vid path vidpath save path savepath isinstance vid writer vidwriter video writer videowriter vid writer vidwriter release release previous video writer fps vid cap vidcap get cappropfps int vid cap vidcap get cappropframewidth int vid cap vidcap get cappropframeheight vid writer vidwriter video writer videowriter save path savepath video writer fourcc videowriterfourcc opt fourcc fps vid writer vidwriter write save txt savetxt save img saveimg print results saved getcwd sep platform darwin mac macos system open save path savepath print done time time name main parser argparse argument parser argumentparser parser add argument addargument weights type str default weights yolovs help model path parser add argument addargument source type str default inference images help source file folder webcam parser add argument addargument output type str default inference output help output folder output folder parser add argument addargument img size imgsize type int default help inference size pixels parser add argument addargument conf thres confthres type float default help object confidence threshold parser add argument addargument iou thres iouthres type float default help iou threshold nms parser add argument addargument fourcc type str default mpv help output video codec verify ffmpeg support parser add argument addargument half action store true storetrue help half precision inference parser add argument addargument device default help cuda device cpu parser add argument addargument view img viewimg action store true storetrue help display results parser add argument addargument save txt savetxt action store true storetrue help save results txt parser add argument addargument classes nargs type int help filter class parser add argument addargument agnostic nms agnosticnms action store true storetrue help class agnostic classagnostic nms parser add argument addargument augment action store true storetrue help augmented inference opt parser parse args parseargs print opt torch grad nograd detect
