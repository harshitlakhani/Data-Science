initial commit
import glob import math import import random import shutil import time pathlib import path threading import thread import import numpy import torch pil import image exif tags exiftags torch utils data import dataset tqdm import tqdm utils utils import xyxyxywh xywhxyxy help url helpurl https github com ultralytics yolov wiki train custom data traincustomdata img formats imgformats bmp jpg jpeg png tif dng vid formats vidformats mov avi get orientation exif tag orientation exif tags exiftags tags keys exif tags exiftags tag sorientation tagsorientation orientation break def exif size exifsize img returns exif corrected exifcorrected pil size img size width height try rotation dict img getexif items orientation rotation rotation elif rotation rotation except pass return class load images loadimages inference def init self path img size imgsize path str path path agnostic osagnostic files path isdir path files sorted glob glob path join path elif path isfile path files path images files path splitext lower img formats imgformats videos files path splitext lower vid formats vidformats len images len videos self img size imgsize img size imgsize self files images videos self number files self video flag videoflag false true self mode images videos self new video newvideo videos new video else self cap none assert self images videos found path def iter self self count return self def next self self count self raise stop iteration stopiteration path self filesself count self video flagself videoflagself count read video self mode video ret val retval img self cap read ret val retval self count self cap release self count self last video raise stop iteration stopiteration else path self filesself count self new video newvideo path ret val retval img self cap read self frame print video self count self self frame self nframes path end else read image self count img imread path bgr assert img none image found path print image self count self path end padded resize img letterbox img new shape newshape self img size imgsize convert img img transpose bgr rgb img ascontiguousarray img imwrite path letterbox jpg img transpose save letterbox image return path img img self cap def new video newvideo self path self frame self cap video capture videocapture path self nframes int self cap get cappropframecount def len self return self number files class load webcam loadwebcam inference def init self pipe img size imgsize self img size imgsize img size imgsize pipe pipe local camera pipe rtsp camera pipe rtsp username password camera login pipe rtsp rtplive eefaeedaa traffic camera pipe http wmccpinetop axiscam net mjpg video mjpg golf camera https answers opencv org question changing gstreamer pipeline opencv pythonsolved changinggstreamerpipelinetoopencvinpythonsolved pipe rtspsrc location rtsp username password latency appsink streamer gstreamer https answers opencv org question video acceleration gstremer pipeline videocapture videoaccelerationgstremerpipelineinvideocapture https stackoverflow com questions install gstreamer support opencv python package installgstreamersupportforopencvpythonpackage install help pipe rtspsrc location rtsp root root axis media axismedia media amp videocodec hresolution protocols gstrtsplowertranstcp rtphdepay queue vaapihdec videoconvert appsink streamer gstreamer self pipe pipe self cap video capture videocapture pipe video capture object self cap set cappropbuffersize set buffer size def iter self self count return self def next self self count wait key waitkey ord quit self cap release destroy windows destroyallwindows raise stop iteration stopiteration read frame self pipe local camera ret val retval img self cap read img flip img flip left right leftright else camera true self cap grab skip frames ret val retval img self cap retrieve ret val retval break print assert ret val retval camera error self pipe img path imgpath webcam jpg print webcam self count end padded resize img letterbox img new shape newshape self img size imgsize convert img img transpose bgr rgb img ascontiguousarray img return img path imgpath img img none def len self return class load streams loadstreams multiple rtsp cameras def init self sources streams txt img size imgsize self mode images self img size imgsize img size imgsize path isfile sources open sources sources strip read splitlines len strip else sources sources len sources self imgs none self sources sources enumerate sources start thread read frames video stream print end cap video capture videocapture else assert cap opened isopened failed open int cap get cappropframewidth int cap get cappropframeheight fps cap get cappropfps self imgsi cap read guarantee first frame thread thread target self update args cap daemon true print success gxg fps fps thread start print newline check common shapes stack letterbox new shape newshape self img size imgsize shape self imgs inference shapes self rect unique axis shape rect inference shapes equal self rect print warning different stream shapes detected optimal performance supply similarly shaped similarlyshaped streams def update self index cap read next stream frame daemon thread cap opened isopened self imgsindex cap read cap grab read every frame self imgsindex cap retrieve time sleep wait time def iter self self count return self def next self self count img self imgs copy wait key waitkey ord quit destroy windows destroyallwindows raise stop iteration stopiteration letterbox img letterbox new shape newshape self img size imgsize auto self rect img stack img stack img convert img img transpose bgr rgb bsxxx img ascontiguousarray img return self sources img img none def len self return frames streams fps years class load images labels loadimagesandlabels dataset training testing def init self path img size imgsize batch size batchsize augment false hyp none rect false image weights imageweights false cache images cacheimages false single cls singlecls false try path str path path agnostic osagnostic parent str path path parent sep path isfile path file open path read splitlines replace parent startswith else local global path elif path isdir path folder glob iglob path sep else raise exception exist path self img files imgfiles replace sep path splitext lower img formats imgformats except raise exception error loading data see path help url helpurl len self img files imgfiles assert images found see path help url helpurl floor arange batch size batchsize astype int batch index number batches self number images self batch batch index image self img size imgsize img size imgsize self augment augment self hyp hyp self image weights imageweights image weights imageweights self rect false image weights imageweights else rect self mosaic self augment self rect load images time mosaic training define labels self label files labelfiles replace images labels replace path splitext txt self img files imgfiles rectangular training https github com ultralytics yolov issues self rect read image shapes path replace txt shapes shapefile path try open read existing shapefile split read splitlines assert len shapefile sync except exif size exifsize image open tqdm self img files imgfiles desc reading image shapes savetxt fmt overwrites existing sort aspect ratio array dtype float aspect ratio irect argsort self img files imgfiles self img filesi imgfilesi irect self label files labelfiles self label filesi labelfilesi irect self shapes sirect arirect set training image shapes shapes range ari arbi mini maxi ari min ari max maxi shapesi mini self batch shapes batchshapes ceil array shapes img size imgsize astype int cache labels self imgs none self labels zeros dtype float create datasubset createdatasubset extract bounding boxes extractboundingboxes labels loaded labelsloaded false false false number missing found empty datasubset duplicate labels path nplabelspath str path self label files labelfiles parent npy saved labels npy file path isfile labels path nplabelspath labels path nplabelspath print string load labels path nplabelspath allow pickle allowpickle true len self labels labels loaded labelsloaded true else path replace images labels pbar tqdm self label files labelfiles file enumerate pbar labels loaded labelsloaded self labelsi savetxt file save txt npy file else try open file array split read splitlines dtype float except print missing labels image self img filesi imgfilesi file missing continue shape assert shape label columns file assert negative labels file assert labels found see path dirname file sep help url helpurl labels loaded labelsloaded print saving labels faster future loading labels path nplabelspath save labels path nplabelspath self labels save next time cache images memory faster training warning large datasets may exceed system ram cache images cacheimages training gigabytes cached images pbar tqdm range len self img files imgfiles desc caching images self img imghw self img imghw none none pbar max images self imgsi self img hwi imghwi self img hwi imghwi load image loadimage self img original hworiginal resized hwresized self imgsi nbytes pbar desc caching images fgb detect corrupted images https medium com joelthchao programmatically detect corrupted image cbcd programmaticallydetectcorruptedimagecbcd detect corrupted images detectcorruptedimages false detect corrupted images detectcorruptedimages skimage import conda install conda forge condaforge scikit image scikitimage file tqdm self img files imgfiles desc detecting corrupted images try imread file except print corrupted image detected file def len self return len self img files imgfiles def iter self self count print ran dataset iter self shuffled vector shuffledvector random permutation self self augment else arange self return self def getitem self index self image weights imageweights index self indicesindex hyp self hyp self mosaic load mosaic img labels load mosaic loadmosaic self index shapes none else load image img load image loadimage self index letterbox shape self batch shapesself batchshapesself batchindex self rect else self img size imgsize final letterboxed shape img ratio pad letterbox img shape auto false scaleup self augment shapes pad coco map rescaling load labels labels self labelsindex size normalized xywh pixel xyxy format labels copy labels ratio pad pad width labels ratio pad pad height labels ratio pad labels ratio pad self augment augment imagespace self mosaic img labels random affine randomaffine img labels degrees hyp degrees translate hyp translate scale hyp scale shear hyp shear augment colorspace augment hsv augmenthsv img hgain hyp hsv hsvh sgain hyp hsv hsvs vgain hyp hsv hsvv apply cutouts random random normalized xywh pixel xyxy format labels padw labels padh labels padw labels padh labels append labels concat clip labels len labels labels concatenate labels clip labels labels use center crop clip labels labels use random affine randomaffine augment img imgs int int center crop warning requires box pruning img labels random affine randomaffine img labels degrees self hyp degrees translate self hyp translate scale self hyp scale shear self hyp shear border border remove return img labels def letterbox img new shape newshape color auto true scale fill scalefill false scaleup true resize image pixel multiple pixelmultiple rectangle https github com ultralytics yolov issues shape img shape current shape height width isinstance new shape newshape int new shape newshape new shape newshape new shape newshape scale ratio new old min new shape newshape shape new shape newshape shape scaleup scale scale better test map min compute padding ratio width height ratios new unpad newunpad int round shape int round shape new shape newshape new unpad newunpad new shape newshape new unpad newunpad padding auto minimum rectangle mod mod padding elif scale fill scalefill stretch new unpad newunpad new shape newshape ratio new shape newshape shape new shape newshape shape width height ratios divide padding sides shape new unpad newunpad resize img resize img new unpad newunpad interpolation interlinear top bottom int round int round left right int round int round img copy make border copymakeborder img top bottom left right borderconstant value color add border return img ratio def random affine randomaffine img targets degrees translate scale shear border torchvision transforms random affine randomaffine degrees translate scale shear https medium com uruvideo dataset augmentation random homographies afbd datasetaugmentationwithrandomhomographiesafbd targets cls xyxy height img shape border width img shape border rotation scale eye random uniform degrees degrees random choice add deg rotations small rotations random uniform scale scale random uniform scale scale get rotation matrix getrotationmatrixd angle center img shape img shape scale translation eye random uniform translate translate img shape border translation pixels random uniform translate translate img shape border translation pixels shear eye math tan random uniform shear shear math shear deg math tan random uniform shear shear math shear deg combined rotation matrix order important border eye image changed img warp affine warpaffine img dsize width height flags interlinear border value bordervalue transform label coordinates len targets warp points ones targets reshape reshape create new boxes concatenate min min max max reshape apply angle based anglebased reduction bounding boxes radians math reduction max abs math sin radians abs math cos radians reduction reduction concatenate reshape reject warped points outside image clip width clip height area area targets targets targets targets maximum aspect ratio area area box array xmin ymin xmax ymax dtype float ioa bbox ioa bboxioa box labels intersection area labels labelsioa obscured labels return labels def reduce img size reduceimgsize path data images img size imgsize utils datasets import reduce img size reduceimgsize creates new images reduced imagesreduced folder reduced size images maximum size img size imgsize path new pathnew path reduced reduced images path create folder createfolder path new pathnew tqdm glob glob path try img imread img shape img size imgsize max size ratio img resize img int int interpolation interarea linear fastest fnew replace path path new pathnew replace path suffix jpg imwrite fnew img except print warning image failure def convert imagesbmp convertimagesbmp utils datasets import convert imagesbmp convertimagesbmp save images formats lower img formats imgformats upper img formats imgformats path coco images val coco images train path data images data background create folder createfolder path bmp ext formats bmp jpg jpeg png tif dng tqdm glob glob path ext desc converting ext imwrite replace ext lower bmp replace path path bmp imread save labels path coco trainvalnok txt coco txt file data train outtrain txt data test outtest txt open file lines read lines read replace bmp coco lines lines replace images imagesbmp lines lines replace background backgroundbmp ext formats lines lines replace ext bmp open file replace txt bmp txt write lines def recursive datasetbmp recursivedatasetbmp dataset data bmp smbmp utils datasets import recursive datasetbmp recursivedatasetbmp converts dataset bmp faster training formats lower img formats imgformats upper img formats imgformats files walk dataset file tqdm files desc file path file suffix txt replace text open lines read formats lines lines replace bmp open write lines elif formats replace image imwrite replace bmp imread bmp system def imagelistfolder path data coco img cocoimg txt utils datasets import imagelistfolder copies images text file list images folder create folder createfolder path open path line read splitlines system line path print line def create folder createfolder path new folder newfolder create folder path exists path shutil rmtree path delete output folder makedirs path make new output folder
