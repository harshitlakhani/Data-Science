add compute loss computeloss class
return loss def compute loss computeloss targets model predictions targets model device targets device lcls lbox lobj torch zeros device device torch zeros device device torch zeros device device tcls tbox indices anchors build targets buildtargets targets model targets model hyp hyperparameters define criteria ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight torch tensor cls clspw device device weight model class weights classweights eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight torch tensor obj objpw device device class label smoothing https arxiv org pdf pdf eqn smooth bce smoothbce eps focal loss gamma flgamma focal loss gamma ecls bcecls eobj bceobj focal loss focalloss ecls bcecls focal loss focalloss eobj bceobj losses number targets balance enumerate layer index layer predictions indicesi image anchor gridy gridx tobj torch zeros like zeroslike device device target obj shape number targets cumulative targets pib prediction subset corresponding targets regression pxy sigmoid pwh sigmoid anchorsi pbox torch cat pxy pwh predicted box iou bbox iou bboxiou pbox tboxi xyxy false ciou true iou prediction target lbox iou mean iou loss objectness tobjb model model iou detach clamp type tobj dtype iou ratio classification model cls loss multiple classes torch full like fulllike device device targets trange tclsi lcls ecls bcecls bce append targets text file open targets txt file file write tuple torch cat txyi twhi lobj eobj bceobj tobj balancei obj loss lbox box lobj obj lcls cls tobj shape batch size loss lbox lobj lcls return loss torch cat lbox lobj lcls loss detach def build targets buildtargets targets model build targets compute loss computeloss input targets image class det model module model parallel isparallel model else model model detect module det targets shape number anchors targets tcls tbox indices anch gain torch ones device targets device normalized gridspace gain torch arange device targets device float view repeat repeat interleave repeatinterleave targets torch cat targets repeat none append anchor indices bias torch tensor device targets device float offsets range det anchors det anchorsi gain torch tensor shape xyxy gain match targets anchors targets gain matches anchors none ratio torch max max model hyp iou iout iou iou whiou anchors gwh filter offsets class compute loss computeloss compute losses def init self model autobalance false super compute loss computeloss self init device next model parameters device get model device model hyp hyperparameters define criteria ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight torch tensor cls clspw device device eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight torch tensor obj objpw device device class label smoothing https arxiv org pdf pdf eqn self self smooth bce smoothbce eps focal loss gamma flgamma focal loss gamma ecls bcecls eobj bceobj focal loss focalloss ecls bcecls focal loss focalloss eobj bceobj det model module model parallel isparallel model else model model detect module self balance det self balance det self ssi det stride nonzero tuple astuple false item stride index self ecls bcecls self eobj bceobj self self hyp self autobalance ecls bcecls eobj bceobj model autobalance anchors setattr self getattr det def call self targets predictions targets model device targets device lcls lbox lobj torch zeros device device torch zeros device device torch zeros device device tcls tbox indices anchors self build targets buildtargets targets targets losses enumerate layer index layer predictions indicesi image anchor gridy gridx tobj torch zeros like zeroslike device device target obj shape number targets pib prediction subset corresponding targets regression pxy sigmoid pwh sigmoid anchorsi pbox torch cat pxy pwh predicted box iou bbox iou bboxiou pbox tboxi xyxy false ciou true iou prediction target lbox iou mean iou loss objectness tobjb self self iou detach clamp type tobj dtype iou ratio classification self cls loss multiple classes torch full like fulllike self device device targets trange tclsi self lcls self ecls bcecls bce append targets text file open targets txt file file write tuple torch cat txyi twhi obji self eobj bceobj tobj lobj obji self balancei obj loss self autobalance self balancei self balancei obji detach item self autobalance self balance self balanceself ssi self balance lbox self hyp box lobj self hyp obj lcls self hyp cls tobj shape batch size loss lbox lobj lcls return loss torch cat lbox lobj lcls loss detach def build targets buildtargets self targets build targets compute loss computeloss input targets image class self targets shape number anchors targets tcls tbox indices anch gain torch ones device targets device normalized gridspace gain torch arange device targets device float view repeat repeat interleave repeatinterleave targets torch cat targets repeat none append anchor indices bias torch tensor device targets device float offsets range self anchors self anchorsi gain torch tensor shape xyxy gain match targets anchors targets gain matches anchors none ratio torch max max model hyp iou iout iou iou whiou anchors gwh filter offsets gxy grid gxi gain gxy inverse gxy gxi torch stack torch ones like oneslike repeat offsets torch zeros like zeroslike gxy none none else targets offsets define long image class gxy grid gxi gain gxy inverse gxy gxi torch stack torch ones like oneslike repeat offsets torch zeros like zeroslike gxy none none else targets offsets define long image class gxy grid gwh grid gij gxy offsets long gij grid indices append long anchor indices indices append clamp gain clamp gain image anchor grid indices tbox append torch cat gxy gij gwh box anch append anchorsa anchors tcls append class return tcls tbox indices anch gwh grid gij gxy offsets long gij grid indices append long anchor indices indices append clamp gain clamp gain image anchor grid indices tbox append torch cat gxy gij gwh box anch append anchorsa anchors tcls append class return tcls tbox indices anch
