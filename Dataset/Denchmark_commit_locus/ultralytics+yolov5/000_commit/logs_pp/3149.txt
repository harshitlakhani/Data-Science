utils reorganization utils reorganization add new utils files cleanup simplify reduce datasets remove evolve load webcam loadwebcam cleanup
return inter prod prod inter iou inter area area inter class focal loss focalloss module wraps focal loss around existing loss fcn lossfcn criteria focal loss focalloss bce logits loss bcewithlogitsloss gamma def init self loss fcn lossfcn gamma alpha super focal loss focalloss self init self loss fcn lossfcn loss fcn lossfcn must bce logits loss bcewithlogitsloss self gamma gamma self alpha alpha self reduction loss fcn lossfcn reduction self loss fcn lossfcn reduction none required apply element def forward self pred true loss self loss fcn lossfcn pred true torch exp loss loss self alpha self gamma non zero nonzero power gradient stability implementation https github com tensorflow addons blob tensorflow addons tensorflowaddons losses focal loss focalloss pred prob predprob torch sigmoid pred prob logits true pred prob predprob true pred prob predprob alpha factor alphafactor true self alpha true self alpha modulating factor modulatingfactor self gamma loss alpha factor alphafactor modulating factor modulatingfactor self reduction mean return loss mean elif self reduction sum return loss sum else none return loss def smooth bce smoothbce eps https github com ultralytics yolov issues issuecomment return positive negative label smoothing bce targets return eps eps class bce blur logits loss bceblurwithlogitsloss module ewith logit loss bcewithlogitloss reduced missing label effects def init self alpha super bce blur logits loss bceblurwithlogitsloss self init self loss fcn lossfcn bce logits loss bcewithlogitsloss reduction none must bce logits loss bcewithlogitsloss self alpha alpha def forward self pred true loss self loss fcn lossfcn pred true pred torch sigmoid pred prob logits pred true reduce missing label effects pred true abs reduce missing label false label effects alpha factor alphafactor torch exp self alpha loss alpha factor alphafactor return loss mean def compute loss computeloss targets model predictions targets model device targets device lcls lbox lobj torch zeros device device torch zeros device device torch zeros device device tcls tbox indices anchors build targets buildtargets targets model targets model hyp hyperparameters define criteria ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight torch tensor cls clspw device eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight torch tensor obj objpw device class label smoothing https arxiv org pdf pdf eqn smooth bce smoothbce eps focal loss gamma flgamma focal loss gamma ecls bcecls eobj bceobj focal loss focalloss ecls bcecls focal loss focalloss eobj bceobj losses number targets len number outputs balance else enumerate layer index layer predictions indicesi image anchor gridy gridx tobj torch zeros like zeroslike device device target obj shape number targets cumulative targets pib prediction subset corresponding targets regression pxy sigmoid pwh sigmoid anchorsi pbox torch cat pxy pwh device predicted box iou bbox iou bboxiou pbox tboxi xyxy false ciou true iou prediction target lbox iou mean iou loss objectness tobjb model model iou detach clamp type tobj dtype iou ratio classification model cls loss multiple classes torch full like fulllike device device targets trange tclsi lcls ecls bcecls bce append targets text file open targets txt file file write tuple torch cat txyi twhi lobj eobj bceobj tobj balancei obj loss output count scaling lbox box lobj obj else lcls cls tobj shape batch size loss lbox lobj lcls return loss torch cat lbox lobj lcls loss detach def build targets buildtargets targets model build targets compute loss computeloss input targets image class det model module model parallel isparallel model else model model detect module det targets shape number anchors targets tcls tbox indices anch gain torch ones device targets device normalized gridspace gain torch arange device targets device float view repeat repeat interleave repeatinterleave targets torch cat targets repeat none append anchor indices bias torch tensor device targets device float offsets range det anchors det anchorsi gain torch tensor shape xyxy gain match targets anchors targets gain matches anchors none ratio torch max max model hyp iou iout iou iou whiou anchors gwh filter offsets gxy grid gxi gain gxy inverse gxy gxi torch stack torch ones like oneslike repeat offsets torch zeros like zeroslike gxy none none else targets offsets define long image class gxy grid gwh grid gij gxy offsets long gij grid indices append long anchor indices indices append clamp gain clamp gain image anchor grid indices tbox append torch cat gxy gij gwh box anch append anchorsa anchors tcls append class return tcls tbox indices anch def non max suppression nonmaxsuppression prediction conf thres confthres iou thres iouthres merge false classes none agnostic false performs non maximum nonmaximum suppression nms inference results
