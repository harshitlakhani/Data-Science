initial commit
import math import import time copy import deepcopy import torch import torch backends cudnn cudnn import torch import torch functional def init seeds initseeds seed torch manual seed manualseed seed reduce randomness may slower tesla gpus https pytorch org docs stable notes randomness html seed cudnn deterministic false cudnn benchmark true def select device selectdevice device apex false batch size batchsize none device cpu cpu request cpurequest device lower cpu device cpu request cpurequest device requested cpu environ cudavisibledevices device set environment variable assert torch cuda available isavailable cuda unavailable invalid device requested device check availablity cuda false cpu request cpurequest else torch cuda available isavailable cuda bytes torch cuda device count devicecount batch size batchsize check batch size batchsize compatible device count devicecount assert batch size batchsize batch size batchsize multiple gpu count batch size batchsize torch cuda get device properties getdeviceproperties range using cuda apex apex else apex mixed precision https github com nvidia apex range len print sdeviceg cuda device properties cudadeviceproperties name total memory totalmemory dmb name total memory totalmemory else print using cpu print skip line return torch device cuda cuda else cpu def time synchronized timesynchronized torch cuda synchronize torch cuda available isavailable else none return time time def initialize weights initializeweights model model modules type convd pass init kaiming normal kaimingnormal weight mode fan fanout nonlinearity relu elif batch normd batchnormd eps momentum elif leaky leakyrelu relu relu inplace true def find modules findmodules model mclass convd finds layer indices matching module class mclass return enumerate model module list modulelist isinstance mclass def fuse conv fuseconvandbn conv https tehnokv com posts fusing batchnorm conv fusingbatchnormandconv torch grad nograd init fusedconv torch convd conv channels inchannels conv channels outchannels kernel size kernelsize conv kernel size kernelsize stride conv stride padding conv padding bias true prepare filters conv wconv conv weight clone view conv channels outchannels wbn torch diag weight div torch sqrt eps running var runningvar fusedconv weight copy torch wbn conv wconv view fusedconv weight size prepare spatial bias conv bias none conv bconv conv bias else conv bconv torch zeros conv weight size bbn bias weight mul running mean runningmean div torch sqrt running var runningvar eps fusedconv bias copy torch wbn conv bconv reshape reshape bbn return fusedconv def model info modelinfo model verbose false plots line line linebyline description torch pytorch model sum numel model parameters number parameters sum numel model parameters requires grad requiresgrad number gradients verbose print layer name gradient parameters shape sigma name enumerate model named parameters namedparameters name name replace module list modulelist print name requires grad requiresgrad numel list shape mean std try flops thop import profile macs profile model inputs torch zeros verbose false gflops macs except print model summary layers parameters gradientss len list model parameters def load classifier loadclassifier name resnet loads pretrained model reshaped class nclass output import pretrainedmodels https github com cadene pretrained models pretrainedmodels pytorchtorchvision model pretrainedmodels dictname num classes numclasses pretrained imagenet display model properties model input size inputsize model input space inputspace model input range inputrange model mean model std print eval reshape output classes filters model last linear lastlinear weight shape model last linear lastlinear bias torch parameter torch zeros model last linear lastlinear weight torch parameter torch zeros filters model last linear lastlinear features outfeatures return model def scale img scaleimg img ratio shape sameshape true img ratio scales img ratio img shape int ratio int ratio new size img interpolate img size mode bilinear align corners aligncorners false resize shape sameshape pad crop img pixels grid size math ceil ratio return pad img value value imagenet mean class model ema modelema model exponential moving average https github com rwightman pytorch image models pytorchimagemodels keep moving average everything model state dict statedict parameters buffers intended allow functionality like https www tensorflow org api docs apidocs python train exponential moving average exponentialmovingaverage smoothed version weights necessary training schemes perform well google hyper params hyperparams training mnas net mnasnet mobile net mobilenetv efficient net efficientnet etc use sprop rmsprop short epoch decay period slow decay rate requires ema smoothing weights match results pay attention decay constant using relative update count per epoch keep ema using gpu resources set device cpu save bit memory disable validation ema weights validation done manually separate process training stops converging class sensitive initialized sequence model init gpu assignment distributed training wrappers tested sequence train torch data parallel dataparallel apex ddp single gpu singlegpu def init self model decay device make copy model accumulating moving average weights self ema deepcopy model self ema eval self updates number ema updates self decay lambda decay math exp decay exponential ramp help early epochs self device device perform ema different device model set device self ema device device self ema parameters requires grad requiresgrad false def update self model self updates self decay self updates torch grad nograd type model parallel data parallel dataparallel parallel distributed data parallel distributeddataparallel msd esd model module state dict statedict self ema module state dict statedict else msd esd model state dict statedict self ema state dict statedict esd items dtype floating point isfloatingpoint msdk detach def update attr updateattr self model assign attributes may change training model dict keys startswith setattr self ema getattr model
