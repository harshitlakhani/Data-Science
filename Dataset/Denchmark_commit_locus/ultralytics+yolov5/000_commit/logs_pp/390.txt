initial commit
import argparse import json import yaml torch utils data import data loader dataloader utils datasets import utils utils import def test data weights none batch size batchsize imgsz conf thres confthres iou thres iouthres nms save json savejson false single cls singlecls false augment false model none dataloader none multi label multilabel true verbose false fast accurate initialize load model set device model none device torch utils torchutils select device selectdevice opt device batch size batchsize batch size batchsize remove previous glob glob test batch testbatch jpg remove load model google utils googleutils attempt download attemptdownload weights model torch load weights map location maplocation device model torch utils torchutils model info modelinfo model fuse model fuse model device device type cpu torch cuda device count devicecount model data parallel dataparallel model training false else called train device next model parameters device get model device training true configure run open data data yaml load loader yaml full loader fullloader model dict single cls singlecls else int data number classes iouv torch linspace device iou vector map iouv iouv view comment map niou iouv numel dataloader dataloader none path data test opt task test else data val path val test images dataset load images labels loadimagesandlabels path imgsz batch size batchsize rect true single cls singlecls opt single cls singlecls batch size batchsize min batch size batchsize len dataset dataloader data loader dataloader dataset batch size batchsize batch size batchsize num workers numworkers min cpu count cpucount batch size batchsize batch size batchsize else pin memory pinmemory true collate collatefn dataset collate collatefn seen model eval model torch zeros imgsz imgsz device device device type cpu else none run cococlass coco coco class cocotocococlass class images targets map map map map loss torch zeros device device jdict stats class apclass batch batchi imgs targets paths shapes enumerate tqdm dataloader desc imgs imgs device float uint float targets targets device height width imgs shape batch size channels height width whwh torch tensor width height width height device disable gradients torch grad nograd run model torch utils torchutils time synchronized timesynchronized inf infout train trainout model imgs augment augment inference training outputs torch utils torchutils time synchronized timesynchronized compute loss training model loss hyperparameters loss compute loss computeloss train trainout targets model giou obj cls run nms torch utils torchutils time synchronized timesynchronized output non max suppression nonmaxsuppression inf infout conf thres confthres conf thres confthres iou thres iouthres iou thres iouthres multi label multilabel multi label multilabel torch utils torchutils time synchronized timesynchronized statistics per image pred enumerate output labels targetstargets len labels tcls labels tolist else target class seen pred none stats append torch zeros niou dtype torch bool torch tensor torch tensor tcls continue append text file open test txt file file write tuple pred clip boxes image bounds clip coords clipcoords pred height width append pycocotools json dictionary save json savejson image imageid category categoryid bbox score image imageid int path pathssi stem split box pred clone xyxy scale coords scalecoords imgssi shape box shapessi shapessi original shape box xyxyxywh box xywh box box center top left topleft corner zip pred tolist box tolist jdict append image imageid image imageid category categoryid cococlassint bbox round score round assign predictions incorrect correct torch zeros pred shape niou dtype torch bool device device detected target indices tcls tensor tclstensor labels target boxes tbox xywhxyxy labels whwh per target class cls torch unique tcls tensor tclstensor cls tcls tensor tclstensor nonzero view prediction indices cls pred nonzero view target indices search detections shape prediction target ious ious box iou boxiou predpi tboxti max best ious indices append detections ious iouv nonzero tiij detected target detected detected append correctpij iousj iouv iou thres iouthres len detected targets already located image break append statistics correct conf pcls tcls stats append correct cpu pred cpu pred cpu tcls plot images batch batchi len stats enumerate class apclass print model namesc seen ntc api api print speeds tuple seen imgsz imgsz batch size batchsize tuple training print speed inference nms total per gxg image batch size batchsize save json save json savejson map len jdict img ids imgids int path stem split dataloader dataset img files imgfiles detections vals results detectionsvalsresults json weights split sep replace weights else filename print coco ncoco map pycocotools saving open file json dump jdict file try pycocotools coco import coco pycocotools cocoeval import coc oeval cocoeval https github com cocodataset cocoapi blob master python api pythonapi pycoco eval demo pycocoevaldemo ipynb coco cocogt coco glob glob coco annotations instances val instancesval json initialize coco ground truth api coco cocodt coco cocogt load res loadres initialize coco pred api coco eval cocoeval coc oeval cocoeval coco cocogt coco cocodt bbox coco eval cocoeval params img ids imgids img ids imgids evaluate images coco eval cocoeval evaluate coco eval cocoeval accumulate coco eval cocoeval summarize map map coco eval cocoeval stats update pycocotools results map map except print warning pycocotools must installed numpy run correctly see https github com cocodataset cocoapi issues return results maps zeros map enumerate class apclass mapsc api return map map loss cpu len dataloader tolist maps name main parser argparse argument parser argumentparser prog test parser add argument addargument weights type str default weights yolovs help model path parser add argument addargument data type str default data coco yaml help data path parser add argument addargument batch size batchsize type int default help size image batch parser add argument addargument img size imgsize type int default help inference size pixels parser add argument addargument conf thres confthres type float default help object confidence threshold parser add argument addargument iou thres iouthres type float default help iou threshold nms parser add argument addargument save json savejson action store true storetrue help save cocoapi compatible cocoapicompatible json results file parser add argument addargument task default val help val test study parser add argument addargument device default help cuda device cpu parser add argument addargument single cls singlecls action store true storetrue help treat single class singleclass dataset parser add argument addargument augment action store true storetrue help augmented inference parser add argument addargument verbose action store true storetrue help report map class opt parser parse args parseargs opt save json savejson opt save json savejson opt data endswith sep coco yaml opt data glob glob opt data recursive true find file print opt task val test study opt task val default run normally test opt data opt weights opt batch size batchsize opt img size imgsize opt conf thres confthres opt iou thres iouthres opt save json savejson opt single cls singlecls opt augment elif opt task study run range settings save plot weights yolovs yolovm yolovl yolovx yolov spp yolovspp studyss txt path opt data stem path weights stem filename save list range axis axis img size imgsize print running nrunning point test opt data weights opt batch size batchsize opt conf thres confthres opt iou thres iouthres opt save json savejson append results times savetxt fmt save plot study txt plotstudytxt plot
