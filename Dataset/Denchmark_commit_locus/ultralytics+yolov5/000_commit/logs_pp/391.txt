initial commit
import argparse import torch distributed dist import torch functional import torch optim optim import torch optim scheduler lrscheduler scheduler lrscheduler import yaml torch utils tensorboard import summary writer summarywriter import test import test get map epoch models yolo import model utils datasets import utils utils import mixed precision mixedprecision true try mixed precision training https github com nvidia apex apex import amp except print apex recommended faster mixed precision training https github com nvidia apex mixed precision mixedprecision false installed wdir weights sep weights dir last wdir last best wdir best results file resultsfile results txt hyperparameters hyp initial learning rate sgd adam momentum sgd momentum weight decay weightdecay optimizer weight decay giou giou loss gain cls cls loss gain cls clspw cls bce loss bceloss positive weight positiveweight obj obj loss gain img size imgsize img size imgsize obj objpw obj bce loss bceloss positive weight positiveweight iou iout iou training threshold anchor anchort anchor multiple anchormultiple threshold gamma flgamma focal loss gamma efficient det efficientdet default gamma hsv hsvh image hsv hue hsvhue augmentation fraction hsv hsvs image hsv saturation hsvsaturation augmentation fraction hsv hsvv image hsv value hsvvalue augmentation fraction degrees image rotation deg translate image translation fraction scale image scale gain shear image shear deg print hyp overwrite hyp hyp txt optional glob glob hyp txt print using zip hyp keys loadtxt hypk print focal loss gamma hyp gamma flgamma print using focal loss focalloss gamma hyp gamma flgamma def train hyp epochs opt epochs batch size batchsize opt batch size batchsize weights opt weights initial training weights configure init seeds initseeds open opt data data dict datadict yaml load loader yaml full loader fullloader model dict train path trainpath data dict datadict train test path testpath data dict datadict val opt single cls singlecls else int data dict datadict number classes remove previous results glob glob batch jpg glob glob results file resultsfile remove create model model model opt cfg device image sizes int max model stride grid size max stride opt img size imgsize print warning img size imgsize must multiple max stride opt img size imgsize opt cfg imgsz imgsz test imgsztest make divisible makedivisible opt img size imgsize image sizes train test optimizer nbs nominal batch size accumulate max round nbs batch size batchsize accumulate loss optimizing hyp weight decay weightdecay batch size batchsize accumulate nbs scale weight decay weightdecay optimizer parameter groups model named parameters namedparameters requires grad requiresgrad bias append biases elif weight append apply weight decay else append else optimizer optim adam hyp opt adam else optim sgd hyp momentum hyp momentum nesterov true optimizer add param group addparamgroup params weight decay weightdecay hyp weight decay weightdecay add weight decay weightdecay optimizer add param group addparamgroup params add biases print optimizer groups bias conv weight len len len del load model google utils googleutils attempt download attemptdownload weights start epoch startepoch best fitness bestfitness weights endswith pytorch format chkpt torch load weights map location maplocation device load model try chkpt model chkpt model state dict statedict items model state dict statedict numel numel model load state dict loadstatedict chkpt model strict false except key error keyerror compatible specify weights specify cfg compatible opt weights opt cfg opt weights raise key error keyerror load optimizer chkpt optimizer none optimizer load state dict loadstatedict chkpt optimizer best fitness bestfitness chkpt best fitness bestfitness load results chkpt get training results trainingresults none open results file resultsfile file file write chkpt training results trainingresults write results txt start epoch startepoch chkpt epoch del chkpt mixed precision training https github com nvidia apex mixed precision mixedprecision model optimizer amp initialize model optimizer opt level optlevel verbosity scheduler https arxiv org pdf pdf lambda math cos math epochs cosine scheduler scheduler lrscheduler lambda lambdalr optimizer lambda lrlambda scheduler last epoch lastepoch start epoch startepoch move https discuss pytorch org problem occured resuming optimizer aproblemoccuredwhenresuminganoptimizer plot scheduler plotlrscheduler optimizer scheduler epochs initialize distributed training device type cpu torch cuda device count devicecount torch distributed available isavailable dist init process group initprocessgroup backend nccl distributed backend init method initmethod tcp init method world size worldsize number nodes rank node rank model torch parallel distributed data parallel distributeddataparallel model dataset dataset load images labels loadimagesandlabels train path trainpath imgsz batch size batchsize augment true hyp hyp augmentation hyperparameters rect opt rect rectangular training cache images cacheimages opt cache images cacheimages single cls singlecls opt single cls singlecls mlc concatenate dataset labels max max label class assert mlc else number workers dataloader torch utils data data loader dataloader dataset batch size batchsize batch size batchsize num workers numworkers shuffle opt rect shuffle true unless rectangular training used pin memory pinmemory true collate collatefn dataset collate collatefn testloader testloader torch utils data data loader dataloader load images labels loadimagesandlabels test path testpath imgsz test imgsztest batch size batchsize hyp hyp rect true cache images cacheimages opt cache images cacheimages single cls singlecls opt single cls singlecls batch size batchsize batch size batchsize num workers numworkers pin memory pinmemory true collate collatefn dataset collate collatefn model parameters hyp cls scale coco tuned cocotuned hyp cls current dataset model attach number classes model model hyp hyp attach hyperparameters model model giou loss ratio obj loss objloss giou model class weights classweights labels class weights labelstoclassweights dataset labels device attach class weights model names data dict datadict names class frequency labels concatenate dataset labels torch tensor labels classes torch bincount long minlength model initialize biases initializebiases device plot labels plotlabels labels writer tbwriter add histogram addhistogram classes exponential moving average ema torch utils torchutils model ema modelema model start training time time len dataloader number batches burn nburn max burn burnin iterations max epochs iterations maps zeros map per class results map val giou val objectness val classification print image sizes train test imgsz imgsz test imgsztest print using dataloader workers print starting training epochs epochs torch autograd set detect anomaly setdetectanomaly true epoch range start epoch startepoch epochs epoch model train update image weights optional dataset image weights imageweights model class weights classweights cpu numpy maps class weights image weights imageweights labels image weights labelstoimageweights dataset labels class weights classweights dataset indices random choices range dataset weights image weights imageweights dataset rand weighted idx mloss torch zeros device device mean losses print epoch gpu mem gpumem giou obj cls total targets img size imgsize pbar tqdm enumerate dataloader total progress bar imgs targets paths pbar batch epoch number integrated batches since train start imgs imgs device float uint float burn burnin burn nburn write open results file resultsfile write results map test losses testlosses giou obj cls len opt name opt bucket system gsutil results txt results resultss txt opt bucket opt name tensorboard writer tbwriter tags train giou loss giouloss train obj loss objloss train cls loss clsloss metrics precision metrics recall metrics map metrics val giou loss giouloss val obj loss objloss val cls loss clsloss tag zip list mloss list results tags writer tbwriter add scalar addscalar tag epoch update best map fitness array results reshape fitness fitnessi weighted combination map best fitness bestfitness best fitness bestfitness save model save opt nosave final epoch finalepoch opt evolve save open results file resultsfile create checkpoint chkpt epoch epoch best fitness bestfitness best fitness bestfitness training results trainingresults read model ema ema module hasattr model module else ema ema optimizer none final epoch finalepoch else optimizer state dict statedict save last best delete torch save chkpt last best fitness bestfitness final epoch finalepoch torch save chkpt best del chkpt end epoch end training opt name len isnumeric else fresults flast fbest resultss txt wdir lasts wdir bests zip wdir last wdir best results txt flast fbest fresults path exists rename rename ispt endswith strip optimizer stripoptimizer ispt else none strip optimizer system gsutil weights opt bucket opt bucket ispt else none upload opt evolve plot results plotresults save results png print epochs completed hours epoch start epoch startepoch time time dist destroy process group destroyprocessgroup torch cuda device count devicecount else none torch cuda empty cache emptycache return results name main parser argparse argument parser argumentparser parser add argument addargument epochs type int default parser add argument addargument batch size batchsize type int default parser add argument addargument cfg type str default models yolovs yaml help cfg path parser add argument addargument data type str default data coco yaml help data path parser add argument addargument img size imgsize nargs type int default help train test sizes parser add argument addargument rect action store true storetrue help rectangular training parser add argument addargument resume action store true storetrue help resume training last parser add argument addargument nosave action store true storetrue help save final checkpoint parser add argument addargument notest action store true storetrue help test final epoch parser add argument addargument evolve action store true storetrue help evolve hyperparameters parser add argument addargument bucket type str default help gsutil bucket parser add argument addargument cache images cacheimages action store true storetrue help cache images faster training parser add argument addargument weights type str default help initial weights path parser add argument addargument name default help renames results txt results name resultsname txt supplied parser add argument addargument device default help cuda device cpu parser add argument addargument adam action store true storetrue help use adam optimizer parser add argument addargument single cls singlecls action store true storetrue help train single class singleclass dataset opt parser parse args parseargs opt weights last opt resume else opt weights opt cfg glob glob opt cfg recursive true find file opt data glob glob opt data recursive true find file print opt opt img size imgsize extend opt img size imgsize len opt img size imgsize extend sizes train test device torch utils torchutils select device selectdevice opt device apex mixed precision mixedprecision batch size batchsize opt batch size batchsize check git status checkgitstatus device type cpu mixed precision mixedprecision false train opt evolve writer tbwriter summary writer summarywriter comment opt name print start tensorboard tensorboard logdir runs view http localhost train hyp evolve hyperparameters optional else writer tbwriter none opt notest opt nosave true true test save final epoch opt bucket system gsutil evolve txt opt bucket download evolve txt exists range generations evolve path exists evolve txt evolve txt exists select best hyps mutate select parent parent single parent selection method single weighted loadtxt evolve txt ndmin min len number previous results consider xnp argsort fitness top mutations fitness fitness min weights parent single len xrandom randint random selection xrandom choices range weights weighted selection elif parent weighted reshape sum sum weighted combination mutate mutation probability sigma npr random npr seed int time time array gains len ones mutate change occurs prevent duplicates npr random npr randn npr random clip enumerate hyp keys plt hist ravel hypk mutate clip limits keys iou iout momentum weight decay weightdecay hsv hsvs hsv hsvv translate scale gamma flgamma limits zip keys limits hypk clip hypk train mutation results train hyp copy write mutation results print mutation printmutation hyp results opt bucket plot results plot evolution results plotevolutionresults hyp
