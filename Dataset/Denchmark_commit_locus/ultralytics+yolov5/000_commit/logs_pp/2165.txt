update build targets buildtargets signed signedoffby glenn jocher
def compute loss computeloss targets model predictions targets model device targets device torch cuda float tensor floattensor cuda iscuda else torch tensor lcls lbox lobj device device device lcls lbox lobj torch zeros device device tcls tbox indices anchors build targets buildtargets targets model targets model hyp hyperparameters red mean loss reduction sum mean define criteria ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight cls clspw reduction red device eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight obj objpw reduction red device ecls bcecls bce logits loss bcewithlogitsloss pos weight posweight torch tensor cls clspw device eobj bceobj bce logits loss bcewithlogitsloss pos weight posweight torch tensor obj objpw device class label smoothing https arxiv org pdf pdf eqn class label smoothing https arxiv org pdf pdf eqn smooth bce smoothbce eps focal loss focal loss gamma flgamma focal loss gamma ecls bcecls eobj bceobj focal loss focalloss ecls bcecls focal loss focalloss eobj bceobj per output losses number targets len number outputs balance else enumerate layer index layer predictions indicesi image anchor gridy gridx tobj torch zeros like zeroslike device target obj tobj torch zeros like zeroslike device device target obj shape number targets cumulative targets shape number targets cumulative targets pib prediction subset corresponding targets giou regression pxy sigmoid pwh sigmoid anchorsi pbox torch cat pxy pwh device predicted box giou bbox iou bboxiou pbox tboxi xyxy false giou true giou prediction target lbox giou sum red sum else giou mean giou loss giou bbox iou bboxiou pbox tboxi xyxy false ciou true giou prediction target lbox giou mean giou loss obj objectness tobjb model model giou detach clamp type tobj dtype giou ratio class classification model cls loss multiple classes torch full like fulllike device targets trange tclsi lcls ecls bcecls bce torch full like fulllike device device targets trange tclsi lcls lcls ecls bcecls bce append targets text file open targets txt file file write tuple torch cat txyi twhi lobj eobj bceobj tobj balancei obj loss lobj lobj eobj bceobj tobj balancei obj loss output count scaling lbox giou lobj obj else lcls cls tobj shape batch size red sum loss gain lobj lcls model lbox loss lbox lobj lcls return loss torch cat lbox lobj lcls loss detach
